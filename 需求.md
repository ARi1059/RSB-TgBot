# Bot介绍
一个 Telegram Bot，用于将媒体以 Telegram file_id 的形式"索引存储"为合集，并通过固定 token 的深链接分享合集。支持多级用户权限管理、频道搬运、全员推送等高级功能。

# 功能概览

## 1.1 管理员功能（Admin）

### /start → 欢迎消息 + 功能菜单

显示自定义欢迎消息（支持占位符渲染）

管理员可见的功能按钮：
- 📚 查看合集列表
- 🔍 搜索合集
- 📤 上传文件
- 📢 广播消息
- 🚀 频道搬运
- ✏️ 设置欢迎语
- 👥 管理员管理
- 📞 联系人管理
- 👤 用户管理

### 合集列表展示

显示所有合集列表（分页显示，每页10个）

每个合集显示：
- 📦 标题
- 📝 描述（如果有）
- 📁 文件统计（🎥 视频数 | 🖼️ 图片数，为0不显示）
- 🔗 深链接（空一行单独展示）

管理员可见编辑和删除按钮（每个合集对应）

支持翻页按钮浏览更多合集

### 👤 用户管理（新增）

管理员可以管理用户权限等级：

1. 输入用户的 Username（支持带/不带 @ 符号）
2. 显示用户当前信息：
   - 用户名
   - 姓名
   - Telegram ID
   - 当前权限等级
3. 选择新的权限等级：
   - 👤 普通用户（userLevel = 0）
   - 💎 付费用户（userLevel = 1）
   - 👑 VIP用户（userLevel = 2）
4. 权限修改后立即生效，用户可立即访问对应权限的内容

支持随时取消操作

### 👥 管理员管理（新增）

管理员可以添加或删除管理员：

1. 显示当前管理员ID列表
2. 选择操作：添加管理员 / 删除管理员
3. 输入用户ID（纯数字）
4. 确认操作

特性：
- 修改后立即生效，无需重启 Bot
- .env 文件自动更新，重启后配置持久化
- 不能删除最后一个管理员
- 支持随时取消操作

### 📞 联系人管理（新增）

管理员可以设置或修改管理员联系方式：

1. 显示当前联系人
2. 选择操作：修改联系人 / 新增联系人
3. 输入联系人用户名（不带 @ 符号）
4. 确认操作

特性：
- 修改后立即生效，无需重启 Bot
- .env 文件自动更新
- 支持随时取消操作

### /setwelcome 自定义欢迎消息

管理员可设置 /start 命令的欢迎消息

支持占位符：{{user_first_name}}、{{user_last_name}}、{{user_username}}

支持 Premium Emoji（无需转义）

### /upload 文件上传

连续发送/转发媒体（photo/video/document/audio）

去重（基于 unique_file_id）

完成上传 → 填写标题/描述 → 选择权限等级 → 💾 储存

标题相同的合集会自动追加文件（描述会被覆盖）

保存成功后：
- 固化合集（collection）
- 生成并固定深链 token（一个合集永远一个 token）
- 返回"储存完成 + 深链接 + 编辑/删除按钮"
- 可选择发布到公开频道或私有频道

### 编辑合集

显示合集信息和文件列表

提供"编辑标题/描述"按钮

为每个文件提供删除按钮（每行2个按钮）

点击删除按钮会显示文件预览并请求确认

编辑标题时，如果新标题与其他合集重复，会自动合并文件

管理员专属功能，非管理员无权限访问

### 删除合集

删除指定合集及其所有文件

需要确认才能删除

管理员专属功能，非管理员无权限访问

### /publish 全员推送

向所有激活 Bot 的用户发送一条消息

支持占位符渲染：{{user_first_name}}、{{user_last_name}}、{{user_username}}

支持直接输入 Premium Emoji

分批发送，避免触发限流

自动标记已屏蔽 Bot 的用户为非激活状态

### 🚀 频道搬运（新增）

管理员可以从其他频道搬运内容到 Bot：

配置搬运参数：
- 搬运模式：全频道搬运 / 按日期范围搬运
- 源频道：输入频道用户名或链接
- 内容类型：全部 / 仅图片 / 仅视频
- 关键字过滤：可选，匹配消息文本
- 合集标题：自动创建合集的标题

搬运流程：
1. UserBot 连接到源频道
2. 扫描并过滤匹配的消息
3. 转发媒体文件到 Bot
4. 自动创建合集并保存
5. 实时显示进度

特性：
- 支持代理配置（适配中国大陆网络）
- 自动去重
- 支持媒体组识别
- 实时进度更新

## 1.2 普通用户功能（User）

### /start

无参数时：
- 显示欢迎消息
- 显示功能按钮：
  - 📚 查看合集列表
  - 🔍 搜索合集
- 显示所有可访问的合集列表（根据用户权限过滤）
- 支持翻页浏览

带深链参数时：
- 验证用户权限等级
- 展示合集信息（标题、描述、文件统计）
- 显示可访问和受限文件数量
- 权限不足时提示联系管理员升级
- 以媒体组形式发送可访问的文件（每组最多10个文件）
- 文件过多时自动分成多个媒体组发送

### 🔍 搜索合集

用户点击"搜索合集"按钮

输入关键词

Bot 会搜索标题或描述中包含该关键词的合集

返回匹配的合集列表（分页显示，每页10个）

支持翻页按钮浏览搜索结果

## 1.3 权限系统（新增）

### 用户等级（UserLevel）
- 0 - 普通用户
- 1 - 付费用户
- 2 - VIP用户

### 内容权限等级（PermissionLevel）
- 0 - 普通用户可查看
- 1 - 付费用户可查看
- 2 - VIP用户可查看

### 权限检查逻辑
用户等级 >= 内容权限等级 才能访问

支持合集级和文件级权限控制

权限不足时显示升级提示和管理员联系方式

# 技术架构

## 2.1 技术选型

### 核心框架
- **Bot 框架**：grammY + TypeScript
  - 原因：深链接支持好、会话管理强大、类型安全
  - 插件：@grammyjs/conversations (多步骤上传流程)
- **通信方式**：Long Polling（非 webhook）
  - 原因：连续上传更稳定、开发调试方便、无需公网 IP/SSL

### 数据存储
- **数据库**：PostgreSQL
  - users 表：id, telegram_id, first_name, last_name, username, is_admin, is_active, user_level, activated_at, created_at, updated_at
  - collections 表：id, token, title, description, permission_level, creator_id, created_at, updated_at
  - media_files 表：id, collection_id, file_id, unique_file_id, file_type, permission_level, order, created_at
  - settings 表：id, key, value, created_at, updated_at
- **ORM**：Prisma (类型安全 + 自动迁移)

### UserBot 集成
- **框架**：telegram (GramJS) v2.25.11
- **功能**：频道消息扫描 → 过滤匹配 → 转发到 Bot → 自动归档
- **特性**：支持代理、会话持久化、媒体组识别

### 辅助工具
- **Token 生成**：nanoid (短 hash，适合深链)
- **模板渲染**：正则替换（占位符渲染）
- **日志系统**：自定义 Logger 类（支持工厂模式和实例缓存）
- **错误处理**：统一的错误处理装饰器和包装器
- **权限管理**：UserLevel 和 PermissionLevel 枚举

## 2.2 项目目录结构

```
RSB-TgBot/
├── src/
│   ├── bot/
│   │   ├── index.ts              # Bot 主入口
│   │   ├── conversations/        # 多步骤会话
│   │   │   ├── uploadFlow.ts           # 上传→填写信息→保存
│   │   │   ├── publishFlow.ts          # 全员推送流程
│   │   │   ├── setWelcomeFlow.ts       # 自定义欢迎消息
│   │   │   ├── editCollectionFlow.ts   # 编辑合集流程
│   │   │   ├── transferFlow.ts         # 频道搬运配置
│   │   │   ├── transferExecuteFlow.ts  # 频道搬运执行
│   │   │   ├── searchCollectionFlow.ts # 搜索合集流程
│   │   │   ├── adminManageFlow.ts      # 管理员管理流程
│   │   │   ├── contactManageFlow.ts    # 联系人管理流程
│   │   │   └── userManageFlow.ts       # 用户管理流程
│   │   ├── middlewares/
│   │   │   ├── auth.ts           # 管理员权限检查
│   │   │   └── session.ts        # 会话管理
│   │   └── handlers/
│   │       └── media.ts          # 媒体文件处理
│   ├── userbot/
│   │   ├── client.ts             # UserBot 客户端连接管理
│   │   └── transfer.ts           # 频道搬运逻辑
│   ├── database/
│   │   └── client.ts             # Prisma 客户端单例
│   ├── services/
│   │   ├── collection.ts         # 合集 CRUD
│   │   ├── media.ts              # 媒体文件管理
│   │   ├── user.ts               # 用户管理
│   │   ├── setting.ts            # 系统设置服务
│   │   └── channelPublisher.ts  # 频道发布服务
│   └── utils/
│       ├── token.ts              # Token 生成
│       ├── logger.ts             # 日志工具（支持工厂模式）
│       ├── errorHandler.ts       # 错误处理装饰器
│       ├── permissions.ts        # 权限管理枚举
│       └── template.ts           # 模板渲染服务
├── prisma/
│   └── schema.prisma             # Prisma schema
├── scripts/
│   ├── login-userbot.ts          # UserBot 登录工具
│   ├── backup-data.sh/bat        # 数据备份脚本
│   └── restore-backup.sh/bat     # 数据恢复脚本
├── .env                          # 环境变量
├── .env.example
├── package.json
├── tsconfig.json
└── README.md
```

## 2.3 技术难点与解决方案

### 难点 1：连续上传的会话状态管理
**问题**：用户连续发送多个媒体 → 输入标题/描述 → 保存，需要保持状态
**解决方案**：
- 使用 grammY conversations 插件
- 会话数据临时存储在内存
- 超时自动清理未完成的上传

### 难点 2：媒体去重（unique_file_id）
**问题**：同一文件可能被多次上传，需要基于 `unique_file_id` 去重
**解决方案**：
- 数据库 `unique_file_id` 字段建立唯一索引
- 上传前查询是否已存在，存在则跳过并提示
- 批量上传时统计去重数量

### 难点 3：深链 Token 的唯一性与固定性
**问题**：每个合集需要一个永久不变的短 token
**解决方案**：
- 使用 `nanoid` 生成 8 位短 hash
- 数据库 token 字段唯一索引，冲突时重新生成
- 合集创建时生成，后续不可修改

### 难点 4：多级权限系统的实现
**问题**：需要支持用户等级和内容权限的灵活控制
**解决方案**：
- 用户表增加 `user_level` 字段（0/1/2）
- 合集和文件表增加 `permission_level` 字段（0/1/2）
- 权限检查：`user_level >= permission_level` 才能访问
- 支持合集级和文件级双重权限控制

### 难点 5：频道搬运的媒体组（album）识别
**问题**：Telegram 的 album 会作为多条消息发送，需要识别并按类型过滤
**解决方案**：
- 监听 `message.media_group_id`，相同 ID 的消息属于同一 album
- 按文件类型过滤时，逐条检查 `message.photo`/`message.video` 等
- 支持关键字和日期范围过滤

### 难点 6：全员推送的性能与限流
**问题**：向所有用户推送消息，可能触发 Telegram 限流
**解决方案**：
- 分批发送，每批处理后间隔
- 记录发送失败的用户（bot 被 block），标记为非激活状态
- 使用 try-catch 捕获异常，避免单个失败影响整体

### 难点 7：管理员和联系人配置的即时生效
**问题**：修改 .env 文件后通常需要重启才能生效
**解决方案**：
- 修改文件后同时更新 `process.env` 对象
- 权限检查函数每次都读取 `process.env`，实现即时生效
- .env 文件更新确保重启后配置持久化

### 难点 8：日志系统的内存管理
**问题**：日志输出是否会累积占用内存
**解决方案**：
- 使用 `console.log/error/warn` 直接输出到标准输出流
- 日志内容输出后立即释放，不会在内存中累积
- 使用工厂模式缓存 Logger 实例，避免重复创建
- 生产环境建议使用 PM2 或 Docker 管理日志轮转

---

# 本地开发与部署

## 3.1 环境要求

- **Node.js**: v18 或更高版本
- **PostgreSQL**: v14 或更高版本
- **npm**: v9 或更高版本

## 3.2 本地开发启动

### 1. 克隆项目
```bash
git clone <repository-url>
cd RSB-TgBot
```

### 2. 安装依赖
```bash
npm install
```

### 3. 配置环境变量
```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件，填入以下配置：
BOT_TOKEN=your_bot_token_here
BOT_USERNAME=your_bot_username
ADMIN_IDS=123456789,987654321
ADMIN_CONTACT=@your_admin_username
DATABASE_URL=postgresql://user:password@localhost:5432/rsb_tgbot
PUBLIC_CHANNEL_ID=-1001234567890  # 可选
PRIVATE_CHANNEL_ID=-1001234567890  # 可选
USERBOT_API_ID=12345678  # 可选，用于频道搬运
USERBOT_API_HASH=your_api_hash  # 可选
USERBOT_SESSION=your_session_string  # 可选
HTTP_PROXY=http://127.0.0.1:7890  # 可选，如果需要代理
HTTPS_PROXY=http://127.0.0.1:7890  # 可选
NODE_ENV=development
```

### 4. 设置数据库
```bash
# 创建数据库（在 PostgreSQL 中执行）
createdb rsb_tgbot

# 或使用 psql
psql -U postgres
CREATE DATABASE rsb_tgbot;
\q
```

### 5. 运行数据库迁移
```bash
npx prisma migrate dev
```

### 6. 生成 Prisma Client
```bash
npx prisma generate
```

### 7. （可选）配置 UserBot
如果需要使用频道搬运功能：
```bash
# 运行 UserBot 登录工具
npm run userbot:login

# 按提示输入手机号和验证码
# 登录成功后会显示 Session 字符串
# 将 Session 字符串复制到 .env 的 USERBOT_SESSION
```

### 8. 启动 Bot
```bash
# 开发模式（自动重启）
npm run dev

# 生产模式
npm run build
npm start
```

## 3.3 数据备份与恢复

### 备份数据
```bash
# Linux/Mac
./scripts/backup-data.sh

# Windows
scripts\backup-data.bat
```

### 恢复数据
```bash
# Linux/Mac
./scripts/restore-backup.sh

# Windows
scripts\restore-backup.bat
```

## 3.4 常用命令

```bash
npm run dev              # 开发模式（watch）
npm run build           # 编译 TypeScript
npm start               # 生产模式
npm run userbot:login   # UserBot 登录
npm run prisma:generate # 生成 Prisma 客户端
npm run prisma:migrate  # 数据库迁移
npm run prisma:studio   # Prisma Studio（数据库管理）
```

---

# 已实现功能清单

## ✅ 核心功能
- 媒体文件上传和合集管理
- 深链接分享（固定 token）
- 媒体去重（基于 unique_file_id）
- 合集编辑和删除
- 分页展示合集列表
- 搜索合集功能

## ✅ 权限系统
- 三级用户等级（普通/付费/VIP）
- 三级内容权限（普通/付费/VIP）
- 合集级权限控制
- 文件级权限控制
- 权限不足提示和升级引导

## ✅ 管理功能
- 管理员管理（添加/删除管理员）
- 联系人管理（设置管理员联系方式）
- 用户管理（修改用户权限等级）
- 自定义欢迎消息（支持占位符和 Premium Emoji）
- 全员推送（支持占位符和 Premium Emoji，分批发送）

## ✅ 频道搬运
- UserBot 集成
- 频道消息扫描
- 按日期范围过滤
- 按内容类型过滤（图片/视频）
- 关键字过滤
- 自动创建合集
- 实时进度显示
- 代理支持

## ✅ 技术特性
- TypeScript 类型安全
- Prisma ORM
- 会话管理（grammY conversations）
- 统一日志系统（支持工厂模式）
- 统一错误处理
- 媒体组批量发送（每组最多10个）
- 速率限制和重试机制
- 数据备份和恢复脚本

## ✅ 用户体验
- 内联键盘交互
- 取消按钮（所有会话流程）
- 即时生效（管理员和联系人配置）
- 友好的错误提示
- 进度实时更新
