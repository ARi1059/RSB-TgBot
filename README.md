# RSB Telegram Bot

ä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„ Telegram åª’ä½“èµ„æºç®¡ç†æœºå™¨äººï¼Œæ”¯æŒåª’ä½“åˆé›†ç®¡ç†ã€æƒé™æ§åˆ¶ã€é¢‘é“æ¬è¿å’Œå¤šè´¦å·æ± ç®¡ç†ã€‚

## æ ¸å¿ƒåŠŸèƒ½

### ğŸ“¤ åª’ä½“ç®¡ç†
- æ”¯æŒå›¾ç‰‡ã€è§†é¢‘ã€æ–‡æ¡£ã€éŸ³é¢‘ç­‰å¤šç§åª’ä½“ç±»å‹
- åŸºäº `unique_file_id` çš„æ™ºèƒ½å»é‡
- ä¸‰çº§æƒé™æ§åˆ¶ï¼ˆæ™®é€š/ä»˜è´¹/VIPï¼‰
- æ·±é“¾æ¥åˆ†äº«åˆé›†ï¼ˆ`t.me/bot?start=token`ï¼‰

### ğŸ” æƒé™ç³»ç»Ÿ
- ç”¨æˆ·ç­‰çº§ç®¡ç†ï¼ˆNormal/Paid/VIPï¼‰
- ç®¡ç†å‘˜æƒé™æ§åˆ¶
- å†…å®¹è®¿é—®æƒé™åˆ†çº§
- ç”¨æˆ·æƒé™å‡çº§æµç¨‹

### ğŸ“¢ ç®¡ç†åŠŸèƒ½
- å…¨å‘˜æ¶ˆæ¯å¹¿æ’­
- åˆé›†ç¼–è¾‘ä¸æœç´¢
- ç”¨æˆ·ç®¡ç†ä¸æƒé™è°ƒæ•´
- ç®¡ç†å‘˜è”ç³»äººé…ç½®
- è‡ªå®šä¹‰æ¬¢è¿æ¶ˆæ¯

### ğŸ¤– é¢‘é“æ¬è¿
- æ‰¹é‡è½¬ç§»é¢‘é“å†…å®¹
- å…³é”®è¯è¿‡æ»¤å’Œæ—¥æœŸèŒƒå›´é€‰æ‹©
- å¤š Session è´¦å·æ± ç®¡ç†
- è‡ªåŠ¨åˆ‡æ¢è´¦å·ï¼ˆé™æµæ—¶ï¼‰
- æ–­ç‚¹ç»­ä¼ åŠŸèƒ½
- å®æ—¶è¿›åº¦ç›‘æ§

### ğŸ”„ å¤š Session è´¦å·æ± 

æ”¯æŒä½¿ç”¨å¤šä¸ª Telegram UserBot è´¦å·å®Œæˆå¤§è§„æ¨¡æ¬è¿ä»»åŠ¡ï¼š

- **è´¦å·ç®¡ç†**ï¼šBot å†…ç›´æ¥ç™»å½•ã€æ·»åŠ ã€åˆ é™¤è´¦å·
- **æ™ºèƒ½è°ƒåº¦**ï¼šæŒ‰ä¼˜å…ˆçº§å’Œå¯ç”¨æ€§è‡ªåŠ¨é€‰æ‹©æœ€ä½³è´¦å·
- **è‡ªåŠ¨åˆ‡æ¢**ï¼šè´¦å·è¢«é™æµæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨è´¦å·
- **æ–­ç‚¹ç»­ä¼ **ï¼šä»ä¸­æ–­å¤„ç»§ç»­ï¼Œä¸ä¸¢å¤±è¿›åº¦
- **ç»Ÿè®¡ç›‘æ§**ï¼šå®æ—¶æŸ¥çœ‹è´¦å·çŠ¶æ€ã€è½¬å‘ç»Ÿè®¡ã€é™æµä¿¡æ¯
- **çµæ´»é…ç½®**ï¼šæ”¯æŒç¯å¢ƒå˜é‡æˆ– Bot å†…é…ç½®

## æŠ€æœ¯æ ˆ

- **è¯­è¨€**: TypeScript (ES2022)
- **Bot æ¡†æ¶**: grammY v1.30.0 + @grammyjs/conversations
- **UserBot**: GramJS (Telegram v2.25.11)
- **æ•°æ®åº“**: PostgreSQL + Prisma ORM v5.22.0
- **è¿è¡Œæ—¶**: Node.js
- **å·¥å…·**: axios, nanoid, dotenv

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd RSB-TgBot

# å®‰è£…ä¾èµ–
npm install
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶å¡«å†™å¿…éœ€é…ç½®ï¼š

```env
# Bot åŸºç¡€é…ç½®ï¼ˆå¿…éœ€ï¼‰
BOT_TOKEN=your_bot_token_here          # ä» @BotFather è·å–
BOT_USERNAME=your_bot_username         # Bot ç”¨æˆ·åï¼ˆä¸å« @ï¼‰
ADMIN_IDS=123456789,987654321          # ç®¡ç†å‘˜ Telegram IDï¼ˆé€—å·åˆ†éš”ï¼‰

# æ•°æ®åº“é…ç½®ï¼ˆå¿…éœ€ï¼‰
DATABASE_URL=postgresql://user:password@localhost:5432/rsb_tgbot

# ç¯å¢ƒè®¾ç½®
NODE_ENV=development                    # development æˆ– production

# å¯é€‰é…ç½®
ADMIN_CONTACT=your_admin_username       # ç®¡ç†å‘˜è”ç³»æ–¹å¼
PRIVATE_CHANNEL_ID=-1001234567890      # ç§æœ‰é¢‘é“ IDï¼ˆç”¨äºå‘å¸ƒåˆé›†ï¼‰
HTTP_PROXY=http://127.0.0.1:7890       # HTTP ä»£ç†ï¼ˆå¦‚éœ€è¦ï¼‰
HTTPS_PROXY=http://127.0.0.1:7890      # HTTPS ä»£ç†ï¼ˆå¦‚éœ€è¦ï¼‰
```

### 3. åˆå§‹åŒ–æ•°æ®åº“

```bash
# ç”Ÿæˆ Prisma Client
npm run prisma:generate

# è¿è¡Œæ•°æ®åº“è¿ç§»
npm run prisma:migrate

# ï¼ˆå¯é€‰ï¼‰æ‰“å¼€ Prisma Studio æŸ¥çœ‹æ•°æ®
npm run prisma:studio
```

### 4. å¯åŠ¨ Bot

**å¼€å‘æ¨¡å¼**ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰ï¼š
```bash
npm run dev
```

**ç”Ÿäº§æ¨¡å¼**ï¼š
```bash
# ç¼–è¯‘ TypeScript
npm run build

# å¯åŠ¨ç¼–è¯‘åçš„ä»£ç 
npm start
```

## é…ç½® UserBot è´¦å·ï¼ˆç”¨äºé¢‘é“æ¬è¿ï¼‰

### æ–¹æ³• 1: é€šè¿‡ Bot ç•Œé¢é…ç½®ï¼ˆæ¨èï¼‰

1. å¯åŠ¨ Bot åï¼Œå‘é€ `/session` å‘½ä»¤
2. é€‰æ‹©"æ·»åŠ æ–°è´¦å·"
3. è¾“å…¥è´¦å·åç§°ã€API IDã€API Hash
4. æŒ‰æç¤ºå®Œæˆç™»å½•éªŒè¯

### æ–¹æ³• 2: é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå‘åå…¼å®¹ï¼‰

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```env
USERBOT_API_ID=your_api_id             # ä» https://my.telegram.org è·å–
USERBOT_API_HASH=your_api_hash
USERBOT_SESSION=your_session_string    # ä½¿ç”¨ npm run userbot:login ç”Ÿæˆ
```

ç”Ÿæˆ Session Stringï¼š
```bash
npm run userbot:login
```

## é¡¹ç›®ç»“æ„

```
RSB-TgBot/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ bot/                    # Bot ä¸»é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ commands/           # å‘½ä»¤å¤„ç†å™¨ï¼ˆstart, admin, transfer ç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ conversations/      # 11 ä¸ªå¤šæ­¥éª¤ä¼šè¯æµç¨‹
â”‚   â”‚   â”œâ”€â”€ handlers/           # äº‹ä»¶å¤„ç†å™¨ï¼ˆå›è°ƒã€æ¶ˆæ¯ã€åª’ä½“ï¼‰
â”‚   â”‚   â”œâ”€â”€ middlewares/        # ä¸­é—´ä»¶ï¼ˆè®¤è¯ã€ä¼šè¯ã€å»é‡ï¼‰
â”‚   â”‚   â”œâ”€â”€ setup/              # Bot åˆå§‹åŒ–å’Œå‘½ä»¤æ³¨å†Œ
â”‚   â”‚   â”œâ”€â”€ ui/                 # UI ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ keyboards/      # å†…è”é”®ç›˜å·¥å‚
â”‚   â”‚   â”‚   â”œâ”€â”€ builders/       # æ¶ˆæ¯æ„å»ºå™¨
â”‚   â”‚   â”‚   â””â”€â”€ formatters/     # æ–‡æœ¬æ ¼å¼åŒ–å·¥å…·
â”‚   â”‚   â””â”€â”€ utils/              # è¾…åŠ©å‡½æ•°
â”‚   â”œâ”€â”€ userbot/                # UserBot é¢‘é“æ¬è¿
â”‚   â”‚   â”œâ”€â”€ client.ts           # TelegramClient æ± ç®¡ç†
â”‚   â”‚   â””â”€â”€ transfer.ts         # æ¬è¿é€»è¾‘ä¸ä¼šè¯åˆ‡æ¢
â”‚   â”œâ”€â”€ services/               # ä¸šåŠ¡é€»è¾‘æœåŠ¡ï¼ˆ9 ä¸ªæœåŠ¡ï¼‰
â”‚   â”‚   â”œâ”€â”€ collection.ts       # åˆé›† CRUD + ç¼“å­˜
â”‚   â”‚   â”œâ”€â”€ media.ts            # åª’ä½“æ–‡ä»¶ç®¡ç† + å»é‡
â”‚   â”‚   â”œâ”€â”€ user.ts             # ç”¨æˆ·ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ permission.ts       # æƒé™æ£€æŸ¥
â”‚   â”‚   â”œâ”€â”€ sessionPool.ts      # UserBot ä¼šè¯æ± ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ transfer.ts         # æ¬è¿ä»»åŠ¡è·Ÿè¸ª
â”‚   â”‚   â”œâ”€â”€ setting.ts          # ç³»ç»Ÿè®¾ç½®ï¼ˆæ¬¢è¿æ¶ˆæ¯ç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ channelPublisher.ts # é¢‘é“å‘å¸ƒ
â”‚   â”‚   â””â”€â”€ customerService.ts  # ç”¨æˆ·æ¶ˆæ¯è½¬å‘
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â””â”€â”€ client.ts           # Prisma å®¢æˆ·ç«¯å•ä¾‹
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ index.ts            # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â””â”€â”€ index.ts            # å¸¸é‡å’Œå›è°ƒå®šä¹‰
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ collection.ts       # TypeScript ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ utils/                  # é€šç”¨å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ logger.ts           # æ—¥å¿—å·¥å…·
â”‚       â”œâ”€â”€ cache.ts            # å†…å­˜ç¼“å­˜ï¼ˆå¸¦ TTLï¼‰
â”‚       â”œâ”€â”€ permissions.ts      # æƒé™æšä¸¾å’Œè¾…åŠ©å‡½æ•°
â”‚       â”œâ”€â”€ token.ts            # Token ç”Ÿæˆ
â”‚       â”œâ”€â”€ template.ts         # æ¨¡æ¿æ¸²æŸ“
â”‚       â”œâ”€â”€ errorHandler.ts     # é”™è¯¯å¤„ç†
â”‚       â””â”€â”€ date.ts             # æ—¥æœŸå·¥å…·ï¼ˆåŒ—äº¬æ—¶åŒºï¼‰
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma           # æ•°æ®åº“æ¨¡å‹ï¼ˆ6 ä¸ªæ¨¡å‹ï¼‰
â”‚   â””â”€â”€ migrations/             # æ•°æ®åº“è¿ç§»æ–‡ä»¶
â”œâ”€â”€ scripts/                    # éƒ¨ç½²å’Œå·¥å…·è„šæœ¬
â”œâ”€â”€ dist/                       # ç¼–è¯‘è¾“å‡ºç›®å½•
â”œâ”€â”€ package.json                # é¡¹ç›®ä¾èµ–
â”œâ”€â”€ tsconfig.json               # TypeScript é…ç½®
â””â”€â”€ .env                        # ç¯å¢ƒå˜é‡é…ç½®
```

## æ•°æ®åº“æ¨¡å‹

é¡¹ç›®ä½¿ç”¨ 6 ä¸ª Prisma æ¨¡å‹ï¼š

- **User**: ç”¨æˆ·ä¿¡æ¯å’Œæƒé™ç­‰çº§
- **Collection**: åª’ä½“åˆé›†å…ƒæ•°æ®
- **MediaFile**: åª’ä½“æ–‡ä»¶è®°å½•ï¼ˆå¸¦å»é‡ï¼‰
- **Setting**: ç³»ç»Ÿè®¾ç½®ï¼ˆæ¬¢è¿æ¶ˆæ¯ç­‰ï¼‰
- **TransferTask**: æ¬è¿ä»»åŠ¡è¿›åº¦è·Ÿè¸ª
- **UserBotSession**: UserBot è´¦å·æ± ç®¡ç†

## ä¸»è¦å‘½ä»¤

### ç®¡ç†å‘˜å‘½ä»¤

- `/start` - å¯åŠ¨ Bot / è®¿é—®æ·±é“¾åˆé›†
- `/admin` - ç®¡ç†å‘˜æ§åˆ¶é¢æ¿
- `/upload` - ä¸Šä¼ åª’ä½“æ–‡ä»¶åˆ°åˆé›†
- `/display` - æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰åˆé›†
- `/publish` - å‘æ‰€æœ‰ç”¨æˆ·å¹¿æ’­æ¶ˆæ¯
- `/transfer` - é…ç½®å’Œæ‰§è¡Œé¢‘é“æ¬è¿
- `/session` - ç®¡ç† UserBot è´¦å·æ± 
- `/welcome` - è®¾ç½®æ¬¢è¿æ¶ˆæ¯
- `/contacts` - ç®¡ç†ç®¡ç†å‘˜è”ç³»æ–¹å¼
- `/users` - ç”¨æˆ·ç®¡ç†å’Œæƒé™è°ƒæ•´

### ç”¨æˆ·å‘½ä»¤

- `/start` - æŸ¥çœ‹æ¬¢è¿æ¶ˆæ¯
- `/start <token>` - è®¿é—®æŒ‡å®šåˆé›†ï¼ˆæ·±é“¾æ¥ï¼‰

## å¼€å‘æŒ‡å—

### å¯ç”¨è„šæœ¬

```bash
# å¼€å‘
npm run dev              # å¼€å‘æ¨¡å¼ï¼ˆçƒ­é‡è½½ï¼‰
npm run build            # ç¼–è¯‘ TypeScript
npm start                # è¿è¡Œç¼–è¯‘åçš„ä»£ç 

# UserBot
npm run userbot          # è¿è¡Œ UserBot
npm run userbot:login    # ç™»å½• UserBot ç”Ÿæˆ session

# æ•°æ®åº“
npm run prisma:generate  # ç”Ÿæˆ Prisma Client
npm run prisma:migrate   # è¿è¡Œæ•°æ®åº“è¿ç§»
npm run prisma:studio    # æ‰“å¼€ Prisma Studio GUI

# ç±»å‹æ£€æŸ¥
npm run type-check       # TypeScript ç±»å‹æ£€æŸ¥
npm run prisma:sync      # åŒæ­¥ Prisma + ç±»å‹æ£€æŸ¥
```

### æ·»åŠ æ–°åŠŸèƒ½

1. **æ·»åŠ å‘½ä»¤**: åœ¨ [src/bot/commands/](src/bot/commands/) åˆ›å»ºå‘½ä»¤å¤„ç†å™¨
2. **æ·»åŠ ä¼šè¯æµç¨‹**: åœ¨ [src/bot/conversations/](src/bot/conversations/) åˆ›å»ºå¤šæ­¥éª¤ä¼šè¯
3. **æ·»åŠ ä¸šåŠ¡é€»è¾‘**: åœ¨ [src/services/](src/services/) æ·»åŠ æœåŠ¡å±‚ä»£ç 
4. **æ³¨å†Œå‘½ä»¤**: åœ¨ [src/bot/setup/commands.ts](src/bot/setup/commands.ts) æ³¨å†Œæ–°å‘½ä»¤

### æ•°æ®åº“æ“ä½œ

```bash
# åˆ›å»ºæ–°è¿ç§»
npm run prisma:migrate

# é‡ç½®æ•°æ®åº“ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
npx prisma migrate reset

# æŸ¥çœ‹æ•°æ®åº“å†…å®¹
npm run prisma:studio
```

## éƒ¨ç½²

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

1. é…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡ï¼ˆ`.env.production`ï¼‰
2. ç¼–è¯‘é¡¹ç›®ï¼š`npm run build`
3. è¿è¡Œè¿ç§»ï¼š`npm run prisma:migrate`
4. å¯åŠ¨æœåŠ¡ï¼š`npm start`

### ä½¿ç”¨ PM2 éƒ¨ç½²

```bash
# å®‰è£… PM2
npm install -g pm2

# å¯åŠ¨ Bot
pm2 start dist/bot/index.js --name rsb-bot

# æŸ¥çœ‹æ—¥å¿—
pm2 logs rsb-bot

# é‡å¯
pm2 restart rsb-bot
```

### Docker éƒ¨ç½²

```bash
# ä½¿ç”¨ Docker Compose
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æœåŠ¡
docker-compose down
```

## å¸¸è§é—®é¢˜

### å¦‚ä½•è·å– Telegram Bot Tokenï¼Ÿ

1. åœ¨ Telegram ä¸­æ‰¾åˆ° [@BotFather](https://t.me/BotFather)
2. å‘é€ `/newbot` åˆ›å»ºæ–° Bot
3. æŒ‰æç¤ºè®¾ç½® Bot åç§°å’Œç”¨æˆ·å
4. è·å– Bot Token

### å¦‚ä½•è·å– Telegram IDï¼Ÿ

1. åœ¨ Telegram ä¸­æ‰¾åˆ° [@userinfobot](https://t.me/userinfobot)
2. å‘é€ä»»æ„æ¶ˆæ¯
3. Bot ä¼šè¿”å›ä½ çš„ Telegram ID

### å¦‚ä½•è·å– API ID å’Œ API Hashï¼Ÿ

1. è®¿é—® [https://my.telegram.org](https://my.telegram.org)
2. ç™»å½•ä½ çš„ Telegram è´¦å·
3. è¿›å…¥ "API development tools"
4. åˆ›å»ºåº”ç”¨è·å– API ID å’Œ API Hash

### å¤šè´¦å·æ¬è¿å¦‚ä½•å·¥ä½œï¼Ÿ

Bot ç»´æŠ¤ä¸€ä¸ª UserBot è´¦å·æ± ï¼Œå½“æ‰§è¡Œæ¬è¿ä»»åŠ¡æ—¶ï¼š
1. è‡ªåŠ¨é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„å¯ç”¨è´¦å·
2. å¦‚æœè´¦å·è¢«é™æµï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè´¦å·
3. è®°å½•æ¬è¿è¿›åº¦ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ 
4. å®æ—¶æ›´æ–°è´¦å·çŠ¶æ€å’Œç»Ÿè®¡ä¿¡æ¯

### å¦‚ä½•å¤„ç†ä»£ç†é—®é¢˜ï¼Ÿ

å¦‚æœåœ¨ä¸­å›½å¤§é™†ä½¿ç”¨ï¼Œéœ€è¦é…ç½®ä»£ç†ï¼š

```env
HTTP_PROXY=http://127.0.0.1:7890
HTTPS_PROXY=http://127.0.0.1:7890
```

ç¡®ä¿ä»£ç†æœåŠ¡æ­£åœ¨è¿è¡Œå¹¶å¯è®¿é—®ã€‚

## æŠ€æœ¯ç‰¹æ€§

- **TypeScript**: å®Œæ•´çš„ç±»å‹å®‰å…¨
- **Prisma ORM**: ç±»å‹å®‰å…¨çš„æ•°æ®åº“æ“ä½œ
- **ä¼šè¯ç®¡ç†**: æ”¯æŒå¤æ‚çš„å¤šæ­¥éª¤å¯¹è¯
- **æ™ºèƒ½å»é‡**: åŸºäº `unique_file_id` é˜²æ­¢é‡å¤æ–‡ä»¶
- **ç¼“å­˜æœºåˆ¶**: å†…å­˜ç¼“å­˜æå‡æ€§èƒ½
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯æ•è·å’Œæ—¥å¿—è®°å½•
- **æƒé™ç³»ç»Ÿ**: çµæ´»çš„ä¸‰çº§æƒé™æ§åˆ¶
- **è´¦å·æ± **: å¤šè´¦å·è‡ªåŠ¨è°ƒåº¦å’Œåˆ‡æ¢
- **æ–­ç‚¹ç»­ä¼ **: ä»»åŠ¡ä¸­æ–­åå¯ç»§ç»­æ‰§è¡Œ

## è®¸å¯è¯

MIT License

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼
