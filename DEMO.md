# 多 Session 功能演示

## 功能演示流程

本文档通过文字描述和命令示例，展示多 Session 功能的完整使用流程。

---

## 场景 1：首次添加 Session 账号

### 步骤 1：进入管理界面

**用户操作：**
```
发送命令：/session
```

**Bot 响应：**
```
🔐 Session 账号管理

📊 当前状态：
• 总账号数：0
• 已启用：0
• 可用：0
• 限流中：0

请选择操作：

[➕ 添加新账号] [📋 查看账号列表]
[📊 账号统计] [🔙 返回主菜单]
```

### 步骤 2：开始添加账号

**用户操作：**
```
点击：[➕ 添加新账号]
```

**Bot 响应：**
```
请输入账号名称（用于识别）：
```

**用户输入：**
```
主力账号
```

### 步骤 3：输入 API 凭证

**Bot 响应：**
```
请输入 API ID：
```

**用户输入：**
```
12345678
```

**Bot 响应：**
```
请输入 API Hash：
```

**用户输入：**
```
abcdef1234567890abcdef1234567890
```

### 步骤 4：设置优先级

**Bot 响应：**
```
请输入优先级（数字越大优先级越高，默认 0）：
```

**用户输入：**
```
10
```

### 步骤 5：登录流程

**Bot 响应：**
```
🔐 开始登录流程...
请输入手机号（国际格式，如 +8613800138000）：
```

**用户输入：**
```
+8613800138000
```

**Bot 响应：**
```
📱 验证码已发送，请输入验证码：
```

**用户输入：**
```
12345
```

**Bot 响应（如果需要两步验证）：**
```
🔒 需要两步验证密码，请输入：
```

**用户输入：**
```
my_password
```

### 步骤 6：添加成功

**Bot 响应：**
```
✅ 账号 "主力账号" 添加成功！

🔐 Session 账号管理

📊 当前状态：
• 总账号数：1
• 已启用：1
• 可用：1
• 限流中：0

请选择操作：

[➕ 添加新账号] [📋 查看账号列表]
[📊 账号统计] [🔙 返回主菜单]
```

---

## 场景 2：查看账号列表

### 用户操作

**用户操作：**
```
/session → [📋 查看账号列表]
```

### Bot 响应（单个账号）

```
📋 Session 账号列表

✅ 🟢 #1 主力账号
  📊 总转发：0 | 今日：0
  🎯 优先级：10

[#1 主力账号] [🔴 禁用]
[🗑️ 删除]

[🔙 返回]
```

### Bot 响应（多个账号）

```
📋 Session 账号列表

✅ 🟢 #1 主力账号
  📊 总转发：1250 | 今日：280
  🎯 优先级：10

✅ 🔴 #2 备用账号1
  📊 总转发：850 | 今日：150
  🎯 优先级：5
  ⏳ 限流至：2024-01-15 15:30:00

✅ 🟢 #3 备用账号2
  📊 总转发：420 | 今日：80
  🎯 优先级：0

❌ 🟢 #4 测试账号
  📊 总转发：50 | 今日：10
  🎯 优先级：0

[#1 主力账号] [🔴 禁用]
[🗑️ 删除]

[#2 备用账号1] [🟢 启用]
[🔄 重置限流]
[🗑️ 删除]

[#3 备用账号2] [🔴 禁用]
[🗑️ 删除]

[#4 测试账号] [🟢 启用]
[🗑️ 删除]

[🔙 返回]
```

**图标说明：**
- ✅ = 已启用
- ❌ = 已禁用
- 🟢 = 可用
- 🔴 = 限流中

---

## 场景 3：搬运任务自动切换

### 步骤 1：开始搬运

**用户操作：**
```
/transfer
→ 配置搬运参数
→ 开始搬运
```

**Bot 响应：**
```
🚀 搬运中...

📦 批次：1 (0/300)
✅ 已扫描：0 条消息
🔍 匹配关键字：0 条
📥 已转发：0 个文件
⏱️ 用时：0秒
```

### 步骤 2：正常搬运

**Bot 响应（每 10 个文件更新一次）：**
```
🚀 搬运中...

📦 批次：1 (45/300)
✅ 已扫描：150 条消息
🔍 匹配关键字：45 条
📥 已转发：45 个文件
⚡ 速率：30 文件/分钟
⏱️ 用时：90秒
```

### 步骤 3：触发限流，自动切换

**Bot 响应：**
```
🔄 已切换账号继续搬运

📦 批次：1 (45/300)
✅ 已扫描：150 条消息
🔍 匹配关键字：45 条
📥 已转发：45 个文件
🔄 Session: 2
```

**日志输出：**
```
[2024-01-15 14:30:25] WARN: Session 1 hit FloodWait, need to wait 3600 seconds
[2024-01-15 14:30:26] INFO: Attempting to switch to another available session...
[2024-01-15 14:30:27] INFO: Selected session: 2 - 备用账号1
[2024-01-15 14:30:28] INFO: ✅ Switched from session 1 to session 2
```

### 步骤 4：继续搬运

**Bot 响应：**
```
🚀 搬运中...

📦 批次：1 (120/300)
✅ 已扫描：400 条消息
🔍 匹配关键字：120 条
📥 已转发：120 个文件
⚡ 速率：28 文件/分钟
⏱️ 用时：4分30秒
```

### 步骤 5：完成搬运

**Bot 响应：**
```
✅ 转发完成！Bot 正在创建合集...

📦 批次：1
✅ 已扫描：500 条消息
🔍 匹配关键字：280 条
📥 已转发：280 个文件
⏱️ 用时：15分30秒
```

**最终响应：**
```
✅ 搬运完成！

📦 合集：测试合集
📝 描述：测试描述
📁 文件数量：280
⚠️ 跳过重复：15

🔗 访问链接：
https://t.me/your_bot?start=abc123

[🔙 返回主菜单]
```

---

## 场景 4：所有账号限流

### 步骤 1：最后一个账号也被限流

**Bot 响应：**
```
⚠️ 所有账号均被限流，已暂停

📦 批次：1
✅ 已扫描：350 条消息
📥 已转发：180 个文件
⏳ 最短等待：1800 秒 (约 30 分钟)

💡 任务已保存，请稍后继续或添加新的 session 账号

[🔙 返回主菜单]
```

### 步骤 2：查看账号状态

**用户操作：**
```
/session → [📋 查看账号列表]
```

**Bot 响应：**
```
📋 Session 账号列表

✅ 🔴 #1 主力账号
  📊 总转发：1250 | 今日：280
  🎯 优先级：10
  ⏳ 限流至：2024-01-15 15:30:00

✅ 🔴 #2 备用账号1
  📊 总转发：850 | 今日：150
  🎯 优先级：5
  ⏳ 限流至：2024-01-15 15:00:00

✅ 🔴 #3 备用账号2
  📊 总转发：420 | 今日：80
  🎯 优先级：0
  ⏳ 限流至：2024-01-15 16:00:00

[#1 主力账号] [🔴 禁用]
[🔄 重置限流]
[🗑️ 删除]

[#2 备用账号1] [🔴 禁用]
[🔄 重置限流]
[🗑️ 删除]

[#3 备用账号2] [🔴 禁用]
[🔄 重置限流]
[🗑️ 删除]

[🔙 返回]
```

### 步骤 3：添加新账号

**用户操作：**
```
/session → [➕ 添加新账号]
→ 按提示添加新账号
```

### 步骤 4：继续任务

**用户操作：**
```
/transfer → 继续之前的任务
```

**Bot 响应：**
```
🚀 搬运中...

📦 批次：1 (180/300)
✅ 已扫描：350 条消息
🔍 匹配关键字：180 条
📥 已转发：180 个文件
🔄 Session: 4
⏱️ 用时：0秒
```

---

## 场景 5：管理账号

### 禁用账号

**用户操作：**
```
/session → [📋 查看账号列表]
→ 点击 [🔴 禁用] 按钮
```

**Bot 响应：**
```
✅ 账号已禁用

（返回账号列表，该账号显示为 ❌）
```

### 启用账号

**用户操作：**
```
点击 [🟢 启用] 按钮
```

**Bot 响应：**
```
✅ 账号已启用

（返回账号列表，该账号显示为 ✅）
```

### 重置限流

**用户操作：**
```
点击 [🔄 重置限流] 按钮
```

**Bot 响应：**
```
✅ 限流状态已重置

（返回账号列表，该账号显示为 🟢）
```

### 删除账号

**用户操作：**
```
点击 [🗑️ 删除] 按钮
```

**Bot 响应：**
```
⚠️ 确认删除账号？

账号名称：测试账号
总转发数：50

此操作不可恢复！

[✅ 确认删除] [❌ 取消]
```

**用户操作：**
```
点击 [✅ 确认删除]
```

**Bot 响应：**
```
✅ 账号已删除

（返回账号列表，该账号已消失）
```

---

## 场景 6：查看统计

### 用户操作

**用户操作：**
```
/session → [📊 账号统计]
```

### Bot 响应

```
📊 Session 账号统计

📈 总体统计：
• 总账号数：4
• 已启用：3
• 可用：2
• 限流中：1

📦 转发统计：
• 总转发数：2570
• 今日转发：520
• 平均每账号：642

[🔙 返回]
```

---

## 场景 7：批次限制暂停

### 步骤 1：达到批次限制

**Bot 响应：**
```
⏸️ 批次完成，已暂停

📦 批次：1
✅ 已扫描：800 条消息
🔍 匹配关键字：300 条
📥 本批次转发：300 个文件
📊 总计转发：300 个文件

💡 任务已保存，可稍后继续

[🔙 返回主菜单]
```

### 步骤 2：继续下一批次

**用户操作：**
```
/transfer → 继续任务
```

**Bot 响应：**
```
🚀 搬运中...

📦 批次：2 (0/300)
✅ 已扫描：800 条消息
🔍 匹配关键字：300 条
📥 已转发：300 个文件
⏱️ 用时：0秒
```

---

## 命令行日志示例

### 正常搬运日志

```
[2024-01-15 14:00:00] INFO: Starting transfer task asynchronously
[2024-01-15 14:00:01] INFO: Created new transfer task: 123
[2024-01-15 14:00:02] INFO: Selected session: 1 - 主力账号
[2024-01-15 14:00:03] INFO: Using session 1 for transfer task 123
[2024-01-15 14:00:04] INFO: Fetching channel: @test_channel
[2024-01-15 14:00:05] INFO: Starting to scan and forward messages from newest to oldest...
[2024-01-15 14:00:10] INFO: ✅ Forwarded message 12345, total: 1, batch: 1
[2024-01-15 14:00:12] INFO: ✅ Forwarded message 12346, total: 2, batch: 2
[2024-01-15 14:00:14] INFO: ✅ Forwarded message 12347, total: 3, batch: 3
...
```

### 限流和切换日志

```
[2024-01-15 14:30:25] ERROR: Failed to forward message 12400
[2024-01-15 14:30:25] WARN: Session 1 hit FloodWait, need to wait 3600 seconds
[2024-01-15 14:30:26] INFO: Attempting to switch to another available session...
[2024-01-15 14:30:27] INFO: Selected session: 2 - 备用账号1
[2024-01-15 14:30:28] INFO: ✅ Switched from session 1 to session 2
[2024-01-15 14:30:30] INFO: ✅ Forwarded message 12400, total: 101, batch: 101
[2024-01-15 14:30:32] INFO: ✅ Forwarded message 12401, total: 102, batch: 102
...
```

### 所有账号限流日志

```
[2024-01-15 15:00:00] ERROR: Failed to forward message 12500
[2024-01-15 15:00:00] WARN: Session 2 hit FloodWait, need to wait 1800 seconds
[2024-01-15 15:00:01] INFO: Attempting to switch to another available session...
[2024-01-15 15:00:02] ERROR: Failed to switch to another session
[2024-01-15 15:00:02] ERROR: No available session found
[2024-01-15 15:00:03] INFO: Transfer task paused at message 12500
```

---

## 数据库状态示例

### userbot_sessions 表

```sql
SELECT id, name, is_active, is_available, priority,
       total_transferred, daily_transferred, flood_wait_until
FROM userbot_sessions;
```

**结果：**
```
 id |     name      | is_active | is_available | priority | total_transferred | daily_transferred |   flood_wait_until
----+---------------+-----------+--------------+----------+-------------------+-------------------+----------------------
  1 | 主力账号      | t         | f            |       10 |              1250 |               280 | 2024-01-15 15:30:00
  2 | 备用账号1     | t         | t            |        5 |               850 |               150 | NULL
  3 | 备用账号2     | t         | t            |        0 |               420 |                80 | NULL
  4 | 测试账号      | f         | t            |        0 |                50 |                10 | NULL
```

### transfer_tasks 表

```sql
SELECT id, status, total_scanned, total_matched, total_transferred,
       current_session_id, last_message_id, batch_number
FROM transfer_tasks
ORDER BY created_at DESC
LIMIT 5;
```

**结果：**
```
 id | status  | total_scanned | total_matched | total_transferred | current_session_id | last_message_id | batch_number
----+---------+---------------+---------------+-------------------+--------------------+-----------------+--------------
 10 | running |           350 |           180 |               180 |                  2 |           12500 |            0
  9 | completed |         500 |           280 |               280 |                  1 |           12000 |            0
  8 | paused  |           800 |           300 |               300 |                  1 |           11500 |            0
  7 | failed  |           100 |            50 |                45 |                  1 |           11000 |            0
  6 | completed |        1000 |           500 |               500 |                  1 |           10500 |            1
```

---

## 性能指标示例

### 搬运速率

```
保守模式（FORWARD_RATE: 3000ms）：
- 理论速率：20 文件/分钟
- 实际速率：15-18 文件/分钟
- 限流概率：< 5%

标准模式（FORWARD_RATE: 2000ms）：
- 理论速率：30 文件/分钟
- 实际速率：25-28 文件/分钟
- 限流概率：10-15%

激进模式（FORWARD_RATE: 1000ms）：
- 理论速率：60 文件/分钟
- 实际速率：40-50 文件/分钟
- 限流概率：30-40%
```

### 多账号效果

```
单账号：
- 每日搬运量：500-1000 文件
- 限流次数：2-3 次/天
- 平均暂停时间：2-4 小时

3 个账号（轮换）：
- 每日搬运量：2000-3000 文件
- 限流次数：5-8 次/天
- 平均暂停时间：< 30 分钟

5 个账号（轮换）：
- 每日搬运量：4000-6000 文件
- 限流次数：10-15 次/天
- 平均暂停时间：< 10 分钟
```

---

## 错误处理示例

### 错误 1：API 凭证错误

**用户输入错误的 API ID/Hash**

**Bot 响应：**
```
❌ 登录失败：Invalid API credentials

请检查：
1. API ID 是否正确
2. API Hash 是否正确
3. 是否从 https://my.telegram.org 获取

[🔙 返回]
```

### 错误 2：验证码错误

**用户输入错误的验证码**

**Bot 响应：**
```
❌ 登录失败：Invalid code

请重新开始添加流程

[🔙 返回]
```

### 错误 3：数据库连接失败

**日志输出：**
```
[2024-01-15 14:00:00] ERROR: Failed to connect to database
[2024-01-15 14:00:00] ERROR: Error: connect ECONNREFUSED 127.0.0.1:5432
```

**Bot 响应：**
```
❌ 操作失败，请稍后重试

[🔙 返回主菜单]
```

---

## 总结

本演示文档展示了多 Session 功能的完整使用流程，包括：

✅ 添加和管理 Session 账号
✅ 搬运任务的自动切换
✅ 限流处理和恢复
✅ 账号状态监控
✅ 错误处理

**实际使用建议：**

1. 从 2-3 个账号开始
2. 使用标准速率配置
3. 定期查看账号状态
4. 根据限流情况调整配置
5. 保持账号活跃度

**下一步：**

- 阅读 [MULTI_SESSION_BEST_PRACTICES.md](./MULTI_SESSION_BEST_PRACTICES.md) 了解更多技巧
- 查看 [QUICK_START.md](./QUICK_START.md) 快速上手
- 参考 [MULTI_SESSION_GUIDE.md](./MULTI_SESSION_GUIDE.md) 深入了解

---

**祝使用愉快！** 🚀
